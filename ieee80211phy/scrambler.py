"""
The DATA field, composed of SERVICE, PSDU, tail, and pad parts, shall be scrambled with a length-127
PPDU-synchronous scrambler. The octets of the PSDU are placed in the transmit serial bit stream, bit 0 first
and bit 7 last.
"""


# def scrambler(data_bits: str) -> str:
#     output = ''
#     shr = '1011101'
#     for bit in data_bits:
#         feedback = int(shr[3]) ^ int(shr[6])
#         shr = str(feedback) + shr[:-1]
#         output += str(int(bit) ^ feedback)
#     return output


class bits(str):
    def __new__(cls, val: str):
        if val[0:2] in ('0x', '0X'):
            val = val[2:]
            num_of_bits = int(len(val) * np.log2(16))
            val = int_to_binstr(int(val, 16), num_of_bits)
            val = flip_byte_endian(val)  # IEE802.11 examples need this?!, tho it is confusing

        return str.__new__(cls, val)

    def __getitem__(self, item):
        return bits(self[item])

def scrambler(data: bits) -> bits:
    output = bits('')
    shr = bits('1011101')
    for bit in data:
        feedback = shr[3] ^ shr[6]
        shr = feedback + shr[:-1]
        output += bit ^ feedback
    return output


def descramble(scrambled_bits: str) -> str:
    """ Undo the 'scrambler' """
    return scrambler(scrambled_bits)


def test_i152():
    """
    IEEE Std 802.11-2016: I.1.4.2 Coding the SIGNAL field bits
    """

    # Table I-13â€”The DATA bits before scrambling
    input = '000000000000000000100000010000000000000001110100000000000000011000010000101100111110110001100101000000000000010001101011100000000011110010001111000000000000011000010000101101011101110011110101000000000000000001010010111101101001111000110100000001000100011001001110100101101110011000010110001011100000010011001110000011101000011001001110110101100000010011110110011001100000010000100110100101100110111010010110011101101001011000101110100111100011010001010000001000101000011010101110111001100001011000101110101001100100111000000100111101100110011000000100101000100011011010011110110011101001011010101110101101100011010001010000011000101001011001001110101001101011010010010110011101101100111010010110010011101010011000100110000001001110111010100110000001000010111001001110101001101000011011100110110011001000010001101101000000000000000000000000000000000000000000000000'

    # Table I-15â€”The DATA bits after scrambling ( tail bits set to 0! )
    expect = '011011000001100110001001100011110110100000100001111101001010010101100001010011111101011110101110001001000000110011110011001110101110010010111100010100111001100011000000000111100011010110110011111000111111100000100101011000001101011000100101001101010011001111111110111100000100000100101011100011110101001100011100100000110100000110111110001110010010100001100110010001000110011011001101111101101010001111011000000011011101010010000001001110110010111111011111110000110101100011110111110001100101001011101011011100001000111110011110011010101001000010000001111111010111110010101001110100010101010100010010000001000111010011011001111010010011101111001101100100111000110101111011011111000111000000000010001000001001100110100001011111011000101000100111000101110011100100010101101000001110110010010101000101101001000100010000000000001101110001111111000011101111001011001001'

    output = scrambler(input)

    # test reverse
    rev = descramble(output)
    assert rev == input

    # test against standard -> restore the tail bits to 0
    tail_zeroed = list(output)
    tail_zeroed[816:822] = ['0', '0', '0', '0', '0', '0']
    tail_zeroed = ''.join(tail_zeroed)
    assert tail_zeroed == expect
