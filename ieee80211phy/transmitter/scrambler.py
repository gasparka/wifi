"""
The DATA field, composed of SERVICE, PSDU, tail, and pad parts, shall be scrambled with a length-127
PPDU-synchronous scrambler. The octets of the PSDU are placed in the transmit serial bit stream, bit 0 first
and bit 7 last.
"""


def get_scrambling_sequence(length, initial_state):
    output = ''
    shr = initial_state
    for bit in range(length):
        feedback = str(int(shr[3]) ^ int(shr[6]))
        output += feedback
        shr = str(feedback) + shr[:-1]  # advance the shift register

    return output


def scrambler(data, initial_state='1011101'):
    scrambler = get_scrambling_sequence(len(data), initial_state)
    scrambled_data = [int(data[i]) ^ int(scrambler[i]) for i in range(len(data))]

    output = ''.join(str(bit) for bit in scrambled_data)
    return output


def test_scrambling_sequence_ones():
    """
    The 127-bit sequence generated repeatedly by the scrambler shall be (leftmost used first), 00001110
    11110010 11001001 00000010 00100110 00101110 10110110 00001100 11010100 11100111 10110100
    00101010 11111010 01010001 10111000 1111111, when the all 1s initial state is used.
    """
    expect = '0000111011110010110010010000001000100110001011101011011000001100110101001110011110110100001010101111101001010001101110001111111'
    result = get_scrambling_sequence(len(expect), '1111111')
    assert result == expect


def test_scrambling_sequence_table_i14():
    # Table I-14—Scrambling sequence for seed 1011101
    expect = '0110110000011001101010011100111101101000010101011111010010100011011100011111110000111011110010110010010000001000100110001011101'
    result = get_scrambling_sequence(len(expect), '1011101')
    assert result == expect


def test_i152():
    """
    IEEE Std 802.11-2016: I.1.4.2 Coding the SIGNAL field bits
    """

    # Table I-13—The DATA bits before scrambling
    input = '000000000000000000100000010000000000000001110100000000000000011000010000101100111110110001100101000000000000010001101011100000000011110010001111000000000000011000010000101101011101110011110101000000000000000001010010111101101001111000110100000001000100011001001110100101101110011000010110001011100000010011001110000011101000011001001110110101100000010011110110011001100000010000100110100101100110111010010110011101101001011000101110100111100011010001010000001000101000011010101110111001100001011000101110101001100100111000000100111101100110011000000100101000100011011010011110110011101001011010101110101101100011010001010000011000101001011001001110101001101011010010010110011101101100111010010110010011101010011000100110000001001110111010100110000001000010111001001110101001101000011011100110110011001000010001101101000000000000000000000000000000000000000000000000'

    # Table I-15—The DATA bits after scrambling
    expect = '011011000001100110001001100011110110100000100001111101001010010101100001010011111101011110101110001001000000110011110011001110101110010010111100010100111001100011000000000111100011010110110011111000111111100000100101011000001101011000100101001101010011001111111110111100000100000100101011100011110101001100011100100000110100000110111110001110010010100001100110010001000110011011001101111101101010001111011000000011011101010010000001001110110010111111011111110000110101100011110111110001100101001011101011011100001000111110011110011010101001000010000001111111010111110010101001110100010101010100010010000001000111010011011001111010010011101111001101100100111000110101111011011111000111000000000010001000001001100110100001011111011000101000100111000101110011100100010101101000001110110010010101000101101001000100010000000000001101110001111111000011101111001011001001'


    output = scrambler(input, initial_state='1011101')

    # restore the tail to zeros...
    output = list(output)
    output[816:822] = ['0', '0', '0', '0', '0', '0']
    output = ''.join(output)
    assert output == expect
